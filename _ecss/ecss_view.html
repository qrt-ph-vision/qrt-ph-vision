---
layout: default
title: ECSS Archive
permalink: /ecss/view/
---

{%- assign ecss_docs = site.ecss -%}
{%- if ecss_docs == nil or ecss_docs.size == 0 -%}
  {%- assign ecss_docs = site.pages
    | where_exp: "p", "p.dir contains '/ecss/'"
    | where_exp: "p", "p.dir != '/ecss/'"
  -%}
{%- endif -%}

{%- assign sorted_docs = ecss_docs | sort: "order" -%}
{%- assign ordered_categories = sorted_docs | map: "category" | uniq -%}

{%- comment -%} slug -> 원본 카테고리명 매핑을 JS에 넘기기 {%- endcomment -%}
{%- capture cat_map -%}
{%- assign first = true -%}
{%- for cat in ordered_categories -%}
  {%- if cat == nil or cat == "" -%}{%- continue -%}{%- endif -%}
  {%- unless first -%},{%- endunless -%}
  {%- assign first = false -%}
  "{{ cat | slugify }}": {{ cat | jsonify }}
{%- endfor -%}
{%- endcapture -%}

<article class="post">
  <header class="post-header home">
    <div class="post-title">
      <!-- ✅ front matter title 노출 X, JS가 카테고리명만 넣음 -->
      <span id="ecss-page-title"></span>
    </div>
  </header>

  <!-- ✅ 오른쪽 고정 목차 (manual 디자인/틀 그대로) -->
  <nav id="floating-manual-toc" class="floating-manual-toc" aria-label="목차">
    <div class="toc-head">
      <span class="toc-head-title">CONTENTS</span>
      <button id="toc-toggle" type="button" class="toc-toggle" aria-label="접기/펼치기">▲</button>
    </div>

    <ul class="toc-list" id="toc-list">
      {%- for cat in ordered_categories -%}
        {%- if cat == nil or cat == "" -%}{%- continue -%}{%- endif -%}
        {%- assign cat_slug = cat | slugify -%}
        {%- assign items = sorted_docs | where: "category", cat -%}

        {%- for doc in items -%}
          {%- assign o = doc.order | default: 99999999 -%}
          {%- assign lv2 = o | divided_by: 10000 | modulo: 100 -%}
          {%- assign lv3 = o | divided_by: 100   | modulo: 100 -%}
          {%- assign lv4 = o | modulo: 100 -%}

          {%- if lv2 == 0 and lv3 == 0 and lv4 == 0 -%}
            {%- assign pad = 0 -%}
          {%- elsif lv3 == 0 and lv4 == 0 -%}
            {%- assign pad = 10 -%}
          {%- elsif lv4 == 0 -%}
            {%- assign pad = 20 -%}
          {%- else -%}
            {%- assign pad = 30 -%}
          {%- endif -%}

          <li class="toc-item" data-cat="{{ cat_slug }}" style="padding-left: {{ pad }}px;">
            <a class="toc-link"
               data-target="m{{ doc.order }}"
               data-cat="{{ cat_slug }}"
               href="#{{ cat_slug }}--m{{ doc.order }}">
              {{ doc.title | escape }}
            </a>
          </li>
        {%- endfor -%}
      {%- endfor -%}
    </ul>
  </nav>

  <style>
    .floating-manual-toc{
      position: fixed;
      right: 10px;
      top: 30px;
      width: 220px;
      max-height: calc(100vh - 160px);
      display: flex;
      flex-direction: column;
      transition: width .18s ease;
      border: 1px solid rgba(0, 0, 0, .12);
      border-radius: 12px;
      background: rgba(255, 255, 255, .92);
      box-shadow: 0 8px 18px rgba(0, 0, 0, .10);
      z-index: 9999;
      overflow: hidden;
    }

    .toc-head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:8px 10px;
      border-bottom:1px solid rgba(0,0,0,.10);
      font-weight:800;
      font-size:.9rem;
    }

    .toc-toggle{
      border:none;
      background:transparent;
      cursor:pointer;
      font-size:14px;
      padding:2px 6px;
      border-radius:8px;
      line-height:1;
    }
    .toc-toggle:hover{ background: rgba(0,0,0,.06); }

    .toc-list{
      list-style:none;
      margin:0;
      padding:6px 4px;
      overflow:auto;
      max-height: calc(100vh - 140px);
    }

    .toc-link{
      display:block;
      padding:6px 6px;
      margin:2px 4px;
      border-radius:10px;
      text-decoration:none;
      color:inherit;
      font-size:.84rem;
      line-height:1.2;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .toc-link:hover{
      background: rgba(0,0,0,.06);
      font-weight:800;
    }

    .floating-manual-toc.collapsed{ width:130px; }
    .floating-manual-toc.collapsed .toc-list{ display:none; }
    .floating-manual-toc.collapsed .toc-head-title{
      font-size:.85rem;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    @media (max-width: 1100px){ .floating-manual-toc{ display:none; } }
    @media (min-width: 1101px){
      .post-content{ padding-left:0; padding-right:240px; }
    }

    /* ✅ 점프 앵커 */
    .ecss-anchor{ scroll-margin-top: 90px; height:0; }
  </style>

  <script>
  (function(){
    const CAT_NAME_MAP = { {{ cat_map }} };

    const toc = document.getElementById("floating-manual-toc");
    const btn = document.getElementById("toc-toggle");
    const KEY = "ecss_toc_collapsed_right_v1";
    const titleEl = document.getElementById("ecss-page-title");

    let ticking = false;

    function parseHash(){
      const raw = (location.hash || "").slice(1);
      if (!raw) return { cat:"", anchor:"" };
      const idx = raw.indexOf("--");
      if (idx === -1) return { cat: raw, anchor:"" };
      return { cat: raw.slice(0, idx), anchor: raw.slice(idx + 2) };
    }

    function displayCatName(catSlug){
      return CAT_NAME_MAP[catSlug] || (catSlug ? catSlug.replace(/-/g, " ") : "");
    }

    function applyIcon(){
      if (!toc || !btn) return;
      btn.textContent = toc.classList.contains("collapsed") ? "▼" : "▲";
    }

    function setActive(targetId, cat){
      document.querySelectorAll(".toc-link").forEach(a => {
        const on = (a.dataset.target === targetId && a.dataset.cat === cat);
        a.style.background = on ? "rgba(0, 0, 0, .06)" : "";
        a.style.fontWeight = on ? "800" : "";
      });
    }

    function filterTOC(cat){
      document.querySelectorAll(".toc-item").forEach(li => {
        const c = li.getAttribute("data-cat");
        li.style.display = (!cat || c === cat) ? "" : "none";
      });
    }

    function removeInlineCategoryHeading(cat){
      if (!cat) return;
      const group = document.querySelector(`.ecss-view-group[data-cat="${cat}"]`);
      if (!group) return;

      const expected = displayCatName(cat).trim().toLowerCase();
      const expected2 = cat.replace(/-/g, " ").trim().toLowerCase();

      const firstHeading = group.querySelector("h1, h2");
      if (!firstHeading) return;

      const t = (firstHeading.textContent || "").trim().toLowerCase();
      if (t === expected || t === expected2) firstHeading.remove();
    }

    function updateActiveFromScroll(cat){
      if (!cat) return;

      const anchors = Array.from(document.querySelectorAll(`.ecss-anchor[data-cat="${cat}"]`));
      if (!anchors.length) return;

      const offset = 120;
      let activeId = anchors[0].id;

      for (const a of anchors){
        const top = a.getBoundingClientRect().top;
        if (top - offset <= 0) activeId = a.id;
        else break;
      }

      setActive(activeId, cat);

      const activeLink = document.querySelector(`.toc-link[data-cat="${cat}"][data-target="${activeId}"]`);
      const list = document.getElementById("toc-list");
      if (activeLink && list && toc && !toc.classList.contains("collapsed")){
        const r1 = activeLink.getBoundingClientRect();
        const r2 = list.getBoundingClientRect();
        if (r1.top < r2.top + 20 || r1.bottom > r2.bottom - 20){
          activeLink.scrollIntoView({ block: "center" });
        }
      }
    }

    function applyView(){
      const h = parseHash();

      // ✅ 타이틀은 카테고리명만(없으면 빈칸)
      if (titleEl) titleEl.textContent = h.cat ? displayCatName(h.cat) : "";

      filterTOC(h.cat);

      // ✅ 본문: 해당 카테고리만 보여주기
      document.querySelectorAll(".ecss-view-group").forEach(g => {
        g.style.display = (h.cat && g.dataset.cat === h.cat) ? "block" : "none";
      });

      // ✅ md 안에 카테고리 헤딩이 박혀있으면 첫 1개 제거
      removeInlineCategoryHeading(h.cat);

      // ✅ 점프
      if (h.anchor){
        const el = document.getElementById(h.anchor);
        if (el) el.scrollIntoView({ behavior:"smooth", block:"start" });
      }

      setTimeout(() => updateActiveFromScroll(h.cat), 60);
    }

    function onScroll(){
      if (ticking) return;
      ticking = true;
      requestAnimationFrame(() => {
        const h = parseHash();
        updateActiveFromScroll(h.cat);
        ticking = false;
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      if (toc && btn){
        if (localStorage.getItem(KEY) === null) localStorage.setItem(KEY, "1");
        if (localStorage.getItem(KEY) === "1") toc.classList.add("collapsed");
        applyIcon();

        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          toc.classList.toggle("collapsed");
          localStorage.setItem(KEY, toc.classList.contains("collapsed") ? "1" : "0");
          applyIcon();
        });
      }

      applyView();
      window.addEventListener("scroll", onScroll, { passive:true });
    });

    window.addEventListener("hashchange", applyView);
  })();
  </script>

  <div class="fade-in">
    <div class="post-content">
      {%- for cat in ordered_categories -%}
        {%- if cat == nil or cat == "" -%}{%- continue -%}{%- endif -%}
        {%- assign cat_slug = cat | slugify -%}
        {%- assign items = sorted_docs | where: "category", cat -%}

        <section class="ecss-view-group" data-cat="{{ cat_slug }}" style="display:none;">
          {%- for doc in items -%}
            {%- assign o = doc.order | default: 99999999 -%}
            {%- assign lv2 = o | divided_by: 10000 | modulo: 100 -%}
            {%- assign lv3 = o | divided_by: 100   | modulo: 100 -%}
            {%- assign lv4 = o | modulo: 100 -%}

            {%- if lv2 == 0 and lv3 == 0 and lv4 == 0 -%}
              {%- assign indent = 0 -%}
            {%- elsif lv3 == 0 and lv4 == 0 -%}
              {%- assign indent = 20 -%}
            {%- elsif lv4 == 0 -%}
              {%- assign indent = 40 -%}
            {%- else -%}
              {%- assign indent = 60 -%}
            {%- endif -%}

            <div id="m{{ doc.order }}" class="ecss-anchor" data-cat="{{ cat_slug }}"></div>

            <div style="padding-left: {{ indent }}px; margin-top: 8px;">
              {{ doc.content }}
            </div>
          {%- endfor -%}
        </section>
      {%- endfor -%}
    </div>
  </div>
</article>
